<div class="bg-white rounded-lg shadow p-4 mb-3" data-controller="dataset">
  <div class="flex items-start justify-between">
    <div class="flex gap-2 flex-grow">
      <div class="shrink-0">
        <% logo_classes = "w-6 h-6" %>
        <% container_classes = "flex items-center justify-center w-8 h-8 rounded bg-brand-dark hover:bg-brand-dark/90 cursor-pointer" %>
        <%= link_to dataset.source_url, target: "_blank" do %>
          <% case dataset.source_name.downcase %>
          <% when /cellxgene/ %>
            <div class="<%= container_classes %>">
              <%= image_tag "cellxgene.svg", class: logo_classes, alt: "CellXGene logo" %>
            </div>
          <% when /bgee/ %>
            <div class="<%= container_classes %>">
              <%= image_tag "bgee.svg", class: logo_classes, alt: "Bgee logo" %>
            </div>
          <% when /asap/ %>
            <div class="<%= container_classes %>">
              <%= image_tag "asap.svg", class: logo_classes, alt: "ASAP logo" %>
            </div>
          <% else %>
            <div class="<%= container_classes %>">
              <%= image_tag "default_logo.svg", class: logo_classes, alt: "Default logo" %>
            </div>
          <% end %>
        <% end %>
      </div>
      <div class="flex flex-col h-8">
        <div class="flex flex-col justify-between h-full py-0.5">
          <h2 class="text-xs font-medium text-gray-900 leading-none">
            <%= dataset.source_name %>
          </h2>
          <div class="flex items-center gap-2 text-xs text-gray-600 leading-none">
            <span><%= number_with_delimiter(dataset.cell_count) %> cells</span>
            <span class="text-gray-400">â€¢</span>
            <% if dataset.study.present? %>
              <%= link_to "https://doi.org/#{dataset.study.doi}",
                    target: "_blank",
                    title: dataset.study.title,
                    class: "text-brand-dark hover:text-brand-dark/80" do %>
                <span class="truncate"><%= dataset.study.first_author %>, <%= dataset.study.year %></span>
              <% end %>
            <% else %>
              <%= link_to "https://doi.org/#{dataset.doi}",
                    target: "_blank",
                    class: "text-brand-dark hover:text-brand-dark/80 truncate" do %>
                <%= dataset.doi %>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
    <div class="flex gap-2 shrink-0">
      <% if dataset.explorer_url.present? %>
        <%= link_to "Explore", dataset.explorer_url,
            class: "px-3 py-1.5 text-sm font-medium rounded text-brand-dark bg-brand-light/10 hover:bg-brand-light/20",
            target: "_blank" %>
      <% end %>
    </div>
  </div>
  <div class="flex flex-wrap gap-1.5 mt-2 items-center" data-dataset-target="summary">
    <% tag_categories = {
      organisms: { color: "blue", items: dataset.organisms, name_method: :name },
      cell_types: { color: "green", items: dataset.cell_types, name_method: :name },
      tissues: { color: "purple", items: dataset.tissues, name_method: :name },
      developmental_stages: { color: "orange", items: dataset.developmental_stages, name_method: :name },
      diseases: { color: "red", items: dataset.diseases, name_method: :name },
      sexes: { color: "pink", items: dataset.sexes, name_method: :name },
      technologies: { color: "indigo", items: dataset.technologies, name_method: :protocol_name }
    } %>
    <% tag_categories.each do |category, data| %>
      <% if data[:items].any? %>
        <div class="px-2 py-0.5 rounded-full text-xs bg-<%= data[:color] %>-100 text-<%= data[:color] %>-800 flex items-center max-w-[160px] cursor-pointer" 
             title="<%= data[:items].first.send(data[:name_method]) %>"
             data-action="click->dataset#toggle">
          <div class="truncate">
            <%= data[:items].first.send(data[:name_method]) %>
          </div>
          <% if data[:items].length > 1 %>
            <div class="ml-1 pl-1 flex items-center shrink-0">
              <div class="font-semibold text-<%= data[:color] %>-800">
                +<%= data[:items].length - 1 %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>
  </div>
  <div class="hidden mt-4 space-y-4 relative" data-dataset-target="content">
    <div class="flex flex-wrap gap-6">
      <% if dataset.organisms.any? %>
        <div class="min-w-[200px]">
          <h3 class="font-medium text-sm text-gray-900 mb-2 flex items-center">
            <span class="w-2 h-2 rounded-full bg-blue-500 mr-2"></span>
            Organisms
          </h3>
          <div class="flex flex-wrap gap-1">
            <% dataset.organisms.each do |item| %>
              <span class="px-2 py-0.5 rounded-full text-xs bg-blue-100 text-blue-800">
                <%= item.name %>
              </span>
            <% end %>
          </div>
        </div>
      <% end %>
      <% if dataset.cell_types.any? %>
        <div class="min-w-[200px]">
          <h3 class="font-medium text-sm text-gray-900 mb-2 flex items-center">
            <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span>
            Cell Types
          </h3>
          <div class="flex flex-wrap gap-1">
            <% dataset.cell_types.each do |item| %>
              <span class="px-2 py-0.5 rounded-full text-xs bg-green-100 text-green-800">
                <%= item.name %>
              </span>
            <% end %>
          </div>
        </div>
      <% end %>
      <% if dataset.tissues.any? %>
        <div class="min-w-[200px]">
          <h3 class="font-medium text-sm text-gray-900 mb-2 flex items-center">
            <span class="w-2 h-2 rounded-full bg-purple-500 mr-2"></span>
            Tissues
          </h3>
          <div class="flex flex-wrap gap-1">
            <% dataset.tissues.each do |item| %>
              <span class="px-2 py-0.5 rounded-full text-xs bg-purple-100 text-purple-800">
                <%= item.name %>
              </span>
            <% end %>
          </div>
        </div>
      <% end %>
      <% if dataset.developmental_stages.any? %>
        <div class="min-w-[200px]">
          <h3 class="font-medium text-sm text-gray-900 mb-2 flex items-center">
            <span class="w-2 h-2 rounded-full bg-orange-500 mr-2"></span>
            Developmental Stages
          </h3>
          <div class="flex flex-wrap gap-1">
            <% dataset.developmental_stages.each do |item| %>
              <span class="px-2 py-0.5 rounded-full text-xs bg-orange-100 text-orange-800">
                <%= item.name %>
              </span>
            <% end %>
          </div>
        </div>
      <% end %>
      <% if dataset.diseases.any? %>
        <div class="min-w-[200px]">
          <h3 class="font-medium text-sm text-gray-900 mb-2 flex items-center">
            <span class="w-2 h-2 rounded-full bg-red-500 mr-2"></span>
            Diseases
          </h3>
          <div class="flex flex-wrap gap-1">
            <% dataset.diseases.each do |item| %>
              <span class="px-2 py-0.5 rounded-full text-xs bg-red-100 text-red-800">
                <%= item.name %>
              </span>
            <% end %>
          </div>
        </div>
      <% end %>
      <% if dataset.sexes.any? %>
        <div class="min-w-[200px]">
          <h3 class="font-medium text-sm text-gray-900 mb-2 flex items-center">
            <span class="w-2 h-2 rounded-full bg-pink-500 mr-2"></span>
            Sex
          </h3>
          <div class="flex flex-wrap gap-1">
            <% dataset.sexes.each do |item| %>
              <span class="px-2 py-0.5 rounded-full text-xs bg-pink-100 text-pink-800">
                <%= item.name %>
              </span>
            <% end %>
          </div>
        </div>
      <% end %>
      <% if dataset.technologies.any? %>
        <div class="min-w-[200px]">
          <h3 class="font-medium text-sm text-gray-900 mb-2 flex items-center">
            <span class="w-2 h-2 rounded-full bg-indigo-500 mr-2"></span>
            Technologies
          </h3>
          <div class="flex flex-wrap gap-1">
            <% dataset.technologies.each do |item| %>
              <span class="px-2 py-0.5 rounded-full text-xs bg-indigo-100 text-indigo-800">
                <%= item.protocol_name %>
              </span>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
    <button type="button"
            class="absolute bottom-0 right-0 p-1 rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-700"
            data-action="click->dataset#toggle">
      <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd"
              d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z"
              clip-rule="evenodd" />
      </svg>
    </button>
  </div>
</div>
